# Comprehensive CI/CD pipeline with change detection, selective builds, ECR push, K8s blue-green, and frontend S3/CloudFront
# CI: build + test on PR/push; CD: deploy on push to main

name: LMS CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # --- Change detection ---
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.filter.outputs.common }}
      gateway: ${{ steps.filter.outputs.gateway }}
      service_user: ${{ steps.filter.outputs.service_user }}
      service_auth: ${{ steps.filter.outputs.service_auth }}
      service_course: ${{ steps.filter.outputs.service_course }}
      service_enrollment: ${{ steps.filter.outputs.service_enrollment }}
      service_content: ${{ steps.filter.outputs.service_content }}
      service_assignment: ${{ steps.filter.outputs.service_assignment }}
      service_search: ${{ steps.filter.outputs.service_search }}
      service_notification: ${{ steps.filter.outputs.service_notification }}
      service_payment: ${{ steps.filter.outputs.service_payment }}
      service_analytics: ${{ steps.filter.outputs.service_analytics }}
      frontend: ${{ steps.filter.outputs.frontend }}
      k8s_base: ${{ steps.filter.outputs.k8s_base }}
      k8s_manifests: ${{ steps.filter.outputs.k8s_manifests }}
      backend_any: ${{ steps.filter.outputs.backend_any }}
      services_json: ${{ steps.backend.outputs.services_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'lms-common/**'
              - 'pom.xml'
            gateway:
              - 'lms-gateway/**'
            service_user:
              - 'services/lms-user-service/**'
            service_auth:
              - 'services/lms-auth-service/**'
            service_course:
              - 'services/lms-course-service/**'
            service_enrollment:
              - 'services/lms-enrollment-service/**'
            service_content:
              - 'services/lms-content-service/**'
            service_assignment:
              - 'services/lms-assignment-service/**'
            service_search:
              - 'services/lms-search-service/**'
            service_notification:
              - 'services/lms-notification-service/**'
            service_payment:
              - 'services/lms-payment-service/**'
            service_analytics:
              - 'services/lms-analytics-service/**'
            frontend:
              - 'frontend/**'
            k8s_base:
              - 'k8s/00-base.yaml'
            k8s_manifests:
              - 'k8s/**/*.yaml'

      - name: Compute backend services to build
        id: backend
        run: |
          COMMON="${{ steps.filter.outputs.common }}"
          # If common changes, build everything
          if [ "$COMMON" == "true" ]; then
            echo '["lms-gateway","lms-auth-service","lms-user-service","lms-course-service","lms-enrollment-service","lms-content-service","lms-assignment-service","lms-search-service","lms-notification-service","lms-payment-service","lms-analytics-service"]' > services.json
            echo "build_all=true" >> $GITHUB_OUTPUT
          else
            SERVICES='[]'
            [ "${{ steps.filter.outputs.gateway }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-gateway"]')
            [ "${{ steps.filter.outputs.service_auth }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-auth-service"]')
            [ "${{ steps.filter.outputs.service_user }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-user-service"]')
            [ "${{ steps.filter.outputs.service_course }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-course-service"]')
            [ "${{ steps.filter.outputs.service_enrollment }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-enrollment-service"]')
            [ "${{ steps.filter.outputs.service_content }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-content-service"]')
            [ "${{ steps.filter.outputs.service_assignment }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-assignment-service"]')
            [ "${{ steps.filter.outputs.service_search }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-search-service"]')
            [ "${{ steps.filter.outputs.service_notification }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-notification-service"]')
            [ "${{ steps.filter.outputs.service_payment }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-payment-service"]')
            [ "${{ steps.filter.outputs.service_analytics }}" == "true" ] && SERVICES=$(echo "$SERVICES" | jq '. + ["lms-analytics-service"]')
            echo "$SERVICES" > services.json
            LEN=$(echo "$SERVICES" | jq length)
            [ "$LEN" -gt 0 ] && echo "build_all=false" >> $GITHUB_OUTPUT || echo "build_all=false" >> $GITHUB_OUTPUT
          fi
          echo "services_json<<EOF" >> $GITHUB_OUTPUT
          cat services.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          cat services.json

  # --- Backend build (selective) ---
  backend-build:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      (needs.detect-changes.result == 'success') &&
      (needs.detect-changes.outputs.common == 'true' || fromJSON(needs.detect-changes.outputs.services_json || '[]') | length > 0)
    steps:
      - uses: actions/checkout@v4

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}

      - name: Compute Maven project list
        id: maven
        run: |
          SERVICES='${{ needs.detect-changes.outputs.services_json }}'
          BUILD_ALL='${{ needs.detect-changes.outputs.common }}'
          if [ "$BUILD_ALL" == "true" ] || [ "$SERVICES" == "[]" ] || [ -z "$SERVICES" ]; then
            echo "projects=" >> $GITHUB_OUTPUT
            echo "args=-B clean install" >> $GITHUB_OUTPUT
          else
            PROJS=""
            for s in $(echo "$SERVICES" | jq -r '.[]'); do
              case $s in
                lms-gateway) PROJS="$PROJS,lms-gateway" ;;
                *) PROJS="$PROJS,services/$s" ;;
              esac
            done
            PROJS=$(echo "$PROJS" | sed 's/^,//')
            echo "projects=$PROJS" >> $GITHUB_OUTPUT
            echo "args=-B install -pl $PROJS -am" >> $GITHUB_OUTPUT
          fi

      - name: Build with Maven
        run: |
          ARGS='${{ steps.maven.outputs.args }}'
          if [ -z "$ARGS" ]; then
            mvn -B clean install
          else
            mvn $ARGS
          fi

      - name: Run tests
        run: |
          ARGS='${{ steps.maven.outputs.args }}'
          if [ -z "$ARGS" ] || [ "$ARGS" == "-B clean install" ]; then
            mvn -B test
          else
            PROJS='${{ steps.maven.outputs.projects }}'
            mvn -B test -pl $PROJS -am
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            lms-gateway/target/*.jar
            services/*/target/*.jar
          retention-days: 1

  # --- Frontend build (conditional) ---
  frontend-build:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Run tests
        run: npm test -- --run

      - name: Build production
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || 'https://api.lms-example.com' }}
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # --- Docker build and push to ECR (CD only, push to main) ---
  docker-build-push:
    needs: [detect-changes, backend-build]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.common == 'true' || fromJSON(needs.detect-changes.outputs.services_json || '[]') | length > 0)
    strategy:
      fail-fast: false
      matrix:
        service:
          - { name: lms-gateway, context: lms-gateway, dockerfile: lms-gateway/Dockerfile }
          - { name: lms-auth-service, context: services/lms-auth-service, dockerfile: services/lms-auth-service/Dockerfile }
          - { name: lms-user-service, context: services/lms-user-service, dockerfile: services/lms-user-service/Dockerfile }
          - { name: lms-course-service, context: services/lms-course-service, dockerfile: services/lms-course-service/Dockerfile }
          - { name: lms-enrollment-service, context: services/lms-enrollment-service, dockerfile: services/lms-enrollment-service/Dockerfile }
          - { name: lms-content-service, context: services/lms-content-service, dockerfile: services/lms-content-service/Dockerfile }
          - { name: lms-assignment-service, context: services/lms-assignment-service, dockerfile: services/lms-assignment-service/Dockerfile }
          - { name: lms-search-service, context: services/lms-search-service, dockerfile: services/lms-search-service/Dockerfile }
          - { name: lms-notification-service, context: services/lms-notification-service, dockerfile: services/lms-notification-service/Dockerfile }
          - { name: lms-payment-service, context: services/lms-payment-service, dockerfile: services/lms-payment-service/Dockerfile }
          - { name: lms-analytics-service, context: services/lms-analytics-service, dockerfile: services/lms-analytics-service/Dockerfile }
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build

      - name: Check if service was built
        id: check
        run: |
          SVC="${{ matrix.service.name }}"
          CHANGED='${{ needs.detect-changes.outputs.services_json }}'
          COMMON='${{ needs.detect-changes.outputs.common }}'
          if [ "$COMMON" == "true" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          elif echo "$CHANGED" | jq -e --arg s "$SVC" 'index($s) != null' >/dev/null 2>&1; then
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: steps.check.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Login to Amazon ECR
        if: steps.check.outputs.skip != 'true'
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: steps.check.outputs.skip != 'true'
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY || steps.ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          REGISTRY="${ECR_REGISTRY:-${{ steps.ecr.outputs.registry }}}"
          REPO="${REGISTRY}/lms-${{ matrix.service.name }}"
          docker build -t ${REPO}:${IMAGE_TAG} -t ${REPO}:latest \
            -f ${{ matrix.service.dockerfile }} ${{ matrix.service.context }}
          docker push ${REPO}:${IMAGE_TAG}
          docker push ${REPO}:latest
        continue-on-error: ${{ secrets.AWS_ACCESS_KEY_ID == '' }}

  # --- Deploy to Kubernetes (blue-green, CD only) ---
  deploy-k8s:
    needs: [detect-changes, docker-build-push]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.common == 'true' || fromJSON(needs.detect-changes.outputs.services_json || '[]') | length > 0)
    steps:
      - uses: actions/checkout@v4

      - name: Configure kubectl
        id: kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG || secrets.KUBECONFIG }}
        run: |
          if [ -z "$KUBE_CONFIG" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::KUBE_CONFIG secret not set, skipping K8s deploy"
          else
            mkdir -p ~/.kube
            echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
            chmod 600 ~/.kube/config
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Kubernetes (blue-green)
        if: steps.kubeconfig.outputs.configured == 'true'
        uses: ./.github/actions/deploy-blue-green
        with:
          services: ${{ needs.detect-changes.outputs.services_json }}
          image_tag: ${{ github.sha }}
          ecr_registry: ${{ secrets.ECR_REGISTRY }}

  # --- Deploy frontend to S3 + CloudFront (CD only) ---
  deploy-frontend:
    needs: [detect-changes, frontend-build]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.frontend == 'true' &&
      (secrets.AWS_ACCESS_KEY_ID != '' && secrets.S3_BUCKET != '')
    steps:
      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Sync to S3
        run: |
          cd frontend-dist
          aws s3 sync . s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=3600"

      - name: Invalidate CloudFront
        env:
          CF_DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ -n "$CF_DIST_ID" ]; then
            aws cloudfront create-invalidation --distribution-id "$CF_DIST_ID" --paths "/*"
          fi

  # --- Staging smoke test ---
  staging-smoke:
    runs-on: ubuntu-latest
    needs: [deploy-k8s, deploy-frontend]
    if: |
      always() &&
      (needs.deploy-k8s.result == 'success' || needs.deploy-k8s.result == 'skipped') &&
      (needs.deploy-frontend.result == 'success' || needs.deploy-frontend.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Run k6 smoke test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/load/smoke-test.js
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        continue-on-error: true
